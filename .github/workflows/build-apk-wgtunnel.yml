# ä¸ºstandaloneç‰ˆæœ¬æž„å»ºï¼Œæ­¤å¤–è¿˜æœ‰fdroidå’Œgoogleç‰ˆæœ¬
name: build-apk-wgtunnel

on:
  workflow_dispatch:
  workflow_call:

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Clean runner environment
        run: |
          rm -rf ~/.gradle/caches/transforms-*
          rm -rf ~/.android/build-cache/
          rm -rf ~/.gradle/wrapper/dists/*
        shell: bash

      - name: Checkout source repo
        uses: actions/checkout@main
        with:
          repository: wgtunnel/wgtunnel
          ref: master
          path: wgtunnel_source
          fetch-depth: 0

      - name: Checkout ci source repo (self)
        uses: actions/checkout@main
        with:
          path: ci_source

      - name: Initialization values
        run: |
          echo "BUILD_DATE=$(TZ=UTC-8 date +"%y.%m.%d-%H.%M.%S")" >> $GITHUB_ENV
          GRADLE_VERSION=$(grep -oP 'distributionUrl=.*/gradle-(.*)-bin.zip' $GITHUB_WORKSPACE/wgtunnel_source/gradle/wrapper/gradle-wrapper.properties | grep -oP '(?<=gradle-).*(?=-bin.zip)')
          echo "GRADLE_VERSION=$GRADLE_VERSION" >> $GITHUB_ENV
        shell: bash

      - name: Set up jdk 17
        uses: actions/setup-java@main
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      # æ›¿ä»£android-actions/setup-android@main
      - name: Set up android sdk components
        shell: bash
        run: |
          # è®¾ç½® Android SDK çŽ¯å¢ƒå˜é‡ï¼ˆå¦‚æžœå·²å®‰è£…ï¼‰
          if [ -d "$HOME/Android/sdk" ]; then
            echo "ANDROID_HOME=$HOME/Android/sdk" >> $GITHUB_ENV
            echo "ANDROID_SDK_ROOT=$HOME/Android/sdk" >> $GITHUB_ENV
          elif [ -d "/usr/local/lib/android/sdk" ]; then
            echo "ANDROID_HOME=/usr/local/lib/android/sdk" >> $GITHUB_ENV
            echo "ANDROID_SDK_ROOT=/usr/local/lib/android/sdk" >> $GITHUB_ENV
          fi
          # å¦‚æžœçŽ¯å¢ƒä¸­æœ‰ sdkmanagerï¼Œå®‰è£…å¿…è¦ç»„ä»¶
          if command -v sdkmanager &> /dev/null; then
            yes | sdkmanager --licenses || true
            sdkmanager --install "platform-tools" "platforms;android-36" "build-tools;36.0.0" "ndk-bundle"
          fi

      # - name: Set up android sdk
      #   uses: zxgv5/setup-android@main

      - name: Enable gradle build cache
        working-directory: ./wgtunnel_source
        run: |
          echo "org.gradle.caching=true" >> gradle.properties
          echo "org.gradle.parallel=true" >> gradle.properties
          echo "org.gradle.logging.level=warn" >> gradle.properties
          # ç¦ç”¨å¤œé—´æž„å»ºçš„ç‰ˆæœ¬å·é€’å¢žï¼Œå› ä¸ºæˆ‘ä»¬æž„å»ºçš„æ˜¯ release
          echo "noSplits=true" >> gradle.properties
        shell: bash

      - name: Decode keystore and create local.properties
        working-directory: ./wgtunnel_source
        run: |
          # åˆ›å»º keystore ç›®å½•ï¼ˆé¡¹ç›®æœŸæœ›çš„è·¯å¾„ï¼‰
          mkdir -p keystore
          # å°† base64 ç¼–ç çš„è¯ä¹¦è§£ç ä¸º JKS æ–‡ä»¶åˆ°æ­£ç¡®è·¯å¾„
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > keystore/android_keystore.jks
          # åˆ›å»º local.properties æ–‡ä»¶ï¼ˆLocalProperties.kt ä¼šè¯»å–è¿™ä¸ªæ–‡ä»¶ï¼‰
          cat > local.properties << EOF
          SIGNING_STORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}
          SIGNING_KEY_ALIAS=${{ secrets.KEY_ALIAS }}
          SIGNING_KEY_PASSWORD=${{ secrets.KEY_ALIAS_PASSWORD }}
          KEY_STORE_PATH=keystore/android_keystore.jks
          EOF
          # åŒæ—¶åˆ›å»º signing.properties ç”¨äºŽæœ€åŽä¸€æ­¥çš„ action
          cat > signing.properties << EOF
          storeFile=keystore/android_keystore.jks
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          keyPassword=${{ secrets.KEY_ALIAS_PASSWORD }}
          EOF
          # è®¾ç½®çŽ¯å¢ƒå˜é‡ï¼ˆé¡¹ç›®ä¼šä¼˜å…ˆä½¿ç”¨çŽ¯å¢ƒå˜é‡ï¼‰
          KEY_STORE_PATH=$(realpath keystore/android_keystore.jks)
          echo "KEY_STORE_PATH=$KEY_STORE_PATH" >> $GITHUB_ENV
          echo "SIGNING_STORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          echo "SIGNING_KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
          echo "SIGNING_KEY_PASSWORD=${{ secrets.KEY_ALIAS_PASSWORD }}" >> $GITHUB_ENV
          # æ ¡éªŒæ–‡ä»¶å­˜åœ¨æ€§
          echo "âœ… Created signing files:"
          echo "Keystore path: $KEY_STORE_PATH"
          echo "File exists: $(test -f "$KEY_STORE_PATH" && echo 'Yes' || echo 'No')"
          echo "local.properties created: $(test -f "local.properties" && echo 'Yes' || echo 'No')"
          echo "signing.properties created: $(test -f "signing.properties" && echo 'Yes' || echo 'No')"
        shell: bash

      - name: Build standalone release apk
        working-directory: ./wgtunnel_source
        env:
          KEY_STORE_PATH: ${{ env.KEY_STORE_PATH }}
          SIGNING_STORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          SIGNING_KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.KEY_ALIAS_PASSWORD }}
          ANDROID_HOME: ${{ env.ANDROID_HOME }}
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
        run: |
          set -euo pipefail
          chmod +x ./gradlew
          echo "ðŸ“¦ Building standalone release variant..."
          echo "=== Environment variables ==="
          echo "KEY_STORE_PATH: $KEY_STORE_PATH"
          echo "SIGNING_STORE_PASSWORD: [SET]"
          echo "SIGNING_KEY_ALIAS: $SIGNING_KEY_ALIAS"
          echo "ANDROID_HOME: $ANDROID_HOME"
          echo "============================="
          # æ¸…ç†æž„å»ºç¼“å­˜
          ./gradlew clean
          # é¦–å…ˆæž„å»ºä¾èµ–æ¨¡å—
          echo "ðŸ”¨ Building dependency modules..."
          ./gradlew :logcatter:assembleRelease :networkmonitor:assembleRelease --no-daemon
          # æž„å»º standalone flavor çš„ release ç‰ˆæœ¬
          echo "ðŸ”¨ Building app:standalone release..."
          ./gradlew :app:assembleStandaloneRelease --no-daemon --stacktrace
          # æ£€æŸ¥æž„å»ºç»“æžœ
          echo "ðŸ“ Checking build output..."
          if [ -d "app/build/outputs/apk/standalone/release" ]; then
            echo "âœ… Build completed successfully"
            echo "ðŸ“¦ Built APKs:"
            ls -lh app/build/outputs/apk/standalone/release/
            # æ£€æŸ¥ APK æ–‡ä»¶å¤§å°å’Œç­¾å
            APK_FILE=$(find app/build/outputs/apk/standalone/release -name "*.apk" -type f ! -name "*unsigned*" ! -name "*unaligned*" | head -1)
            if [ -n "$APK_FILE" ]; then
              echo "ðŸ“Š APK info:"
              echo "Size: $(ls -lh "$APK_FILE" | awk '{print $5}')"
              # éªŒè¯ APK ç­¾å
              if command -v apksigner >/dev/null 2>&1; then
                echo "ðŸ” Verifying APK signature..."
                apksigner verify --verbose "$APK_FILE" || echo "âš ï¸  Signature verification failed or apksigner not available"
              fi
            fi
          else
            echo "âŒ Build failed - no output directory found"
            echo "ðŸ” Searching for any build outputs..."
            find app/build -name "*.apk" -type f 2>/dev/null | head -20 || true
            exit 1
          fi
        shell: bash

      - name: Find apk files and rename
        working-directory: ./wgtunnel_source
        run: |
          # æŸ¥æ‰¾ standalone release çš„ APK æ–‡ä»¶
          echo "ðŸ” Searching for standalone release APK..."
          APK_PATH=$(find app/build/outputs/apk/standalone/release -name "*.apk" -type f ! -name "*unsigned*" ! -name "*unaligned*" | head -1)
          if [ -z "$APK_PATH" ]; then
            # å¦‚æžœæ²¡æ‰¾åˆ°ï¼Œå°è¯•åœ¨å…¶ä»–ä½ç½®æŸ¥æ‰¾
            echo "âš ï¸  Not found in expected location, searching elsewhere..."
            APK_PATH=$(find . -name "*.apk" -type f | grep -i "standalone" | grep -i "release" | grep -v unsigned | grep -v unaligned | head -1)
          fi
          if [ -z "$APK_PATH" ]; then
            echo "âŒ No valid standalone release APK found!"
            echo "ðŸ” Searching for any APK files:"
            find . -name "*.apk" -type f 2>/dev/null | head -20 || true
            exit 1
          fi
          echo "âœ… Found APK: $APK_PATH"
          echo "ðŸ“ File details:"
          ls -lh "$APK_PATH"
          # èŽ·å–ç‰ˆæœ¬ä¿¡æ¯ç”¨äºŽå‘½å
          VERSION_INFO=$(unzip -p "$APK_PATH" "assets/version.txt" 2>/dev/null || echo "unknown-version")
          echo "Version info: $VERSION_INFO"
          # é‡å‘½å APK æ–‡ä»¶
          NEW_NAME="wgtunnel-${{ env.BUILD_DATE }}.apk"
          mv "$APK_PATH" "./$NEW_NAME"
          echo "âœ… APK renamed to: $NEW_NAME"
          echo "APK_PATH=./$NEW_NAME" >> $GITHUB_ENV
          echo "APK_FINAL_NAME=$NEW_NAME" >> $GITHUB_ENV
        shell: bash

      - name: Erase keystore, encrypt package and create release
        uses: ./ci_source/.github/actions/erase_aes256pac_release/
        with:
          P12_KEYSTORE_PATH: "./wgtunnel_source/keystore/android_keystore.jks ./wgtunnel_source/signing.properties"
          ZIP_AES256_PWD: ${{ secrets.ZIP_AES256_PWD }}
          BUILD_ARTIFACT_PATH: "./wgtunnel_source/wgtunnel-${{ env.BUILD_DATE }}.apk"
          RELEASE_TAG_NAME: "${{ env.BUILD_DATE }}-wgtunnel"