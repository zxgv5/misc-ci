name: build-apk-zipxtract

on:
  workflow_dispatch:
env:
  ANDROID_COMPILE_SDK: '36'
  ANDROID_BUILD_TOOLS: '36.0.0'
  JDK_VERSION: '21'
  JDK_DISTRIBUTION: 'temurin'
  KEYSTORE_PATH: "./keystore.p12"
  PATCH_FILE_PATH: "./app/src/ps/java/com/wirelessalien/zipxtract/fragment/MainFragment.kt"
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Clean runner environment
        run: |
          # 清理可能存在的全局缓存文件
          rm -rf ~/.gradle/caches/transforms-*
          rm -rf ~/.android/build-cache/

      - name: Checkout source repo
        uses: actions/checkout@main
        with:
          repository: WirelessAlien/ZipXtract
          ref: master
          # ref: v7.1
          path: zipxtract_source
          fetch-depth: 0

      - name: Checkout ci source repo (self)
        uses: actions/checkout@main
        with:
          # 指定一个子目录放ci仓库，避免与源仓库混淆
          path: ci_source

      - name: Setup jdk
        uses: actions/setup-java@main
        with:
          java-version: "${{ env.JDK_VERSION }}"
          distribution: "${{ env.JDK_DISTRIBUTION }}"

      - name: Initialize build environment
        id: init
        run: |
          echo "BUILD_DATE=$(TZ=UTC-8 date +"%y.%m.%d-%H.%M.%S")" >> $GITHUB_ENV
          echo "RELEASE_TYPE=release" >> $GITHUB_ENV
          echo "BUILD_FLAVOR=ps" >> $GITHUB_ENV
          # Get version info from build.gradle
          VERSION_CODE=$(grep 'versionCode' app/build.gradle | head -1 | awk '{print $2}')
          VERSION_NAME=$(grep 'versionName' app/build.gradle | head -1 | awk -F\" '{print $2}')
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV

      - name: Decode keystore file
        working-directory: ./zipxtract_source
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > ${{ env.KEYSTORE_PATH }}

      # - name: Patch source files
      #   working-directory: ./zipxtract_source
      #   run: |
      #     sed -i '/^package /a\'$'\n'"import java.nio.file.Files"'\n'"import java.nio.file.attribute.BasicFileAttributes"'\n' "${{ env.PATCH_FILE_PATH }}"
      #     # 删除冲突的androidx.core.content.Files导入
      #     sed -i '/import androidx.core.content.Files/d' "${{ env.PATCH_FILE_PATH }}"

      - name: Patch source files
        working-directory: ./zipxtract_source
        run: |
          # 第一步：插入带别名的import（替换原有插入命令）
          sed -i '/^package /a\'$'\n'"import java.nio.file.Files as NioFiles"'\n'"import java.nio.file.attribute.BasicFileAttributes"'\n' "${{ env.PATCH_FILE_PATH }}"
          # 第二步：修改代码中调用Files的地方，改为NioFiles（关键）
          # 匹配Files.readAttributes并替换为NioFiles.readAttributes
          sed -i 's/Files\.readAttributes/NioFiles.readAttributes/g' "${{ env.PATCH_FILE_PATH }}"
          # 可选：验证替换结果
          echo "===== Verify NioFiles replacement ====="
          grep -n "NioFiles.readAttributes" "${{ env.PATCH_FILE_PATH }}"

      - name: Verify import fix
        working-directory: ./zipxtract_source
        run: |
          # 打印所有Files/NioFiles相关的import和调用
          echo "===== Final import check ====="
          grep -n "import.*Files\|NioFiles" "${{ env.PATCH_FILE_PATH }}"
          echo "===== Final readAttributes check ====="
          grep -n "readAttributes" "${{ env.PATCH_FILE_PATH }}"

      - name: Build ps release
        working-directory: ./zipxtract_source
        run: |
          echo "Building PS release..."
          chmod +x ./gradlew
          ./gradlew clean
          ./gradlew assemblePsRelease

      - name: Find release apks
        working-directory: ./zipxtract_source
        run: |
          echo "Looking for APK files..."
          PS_APK=$(find . -name "*ps*release*.apk" -type f | head -1)
          if [ -n "$PS_APK" ]; then
            echo "Found PS APK: $PS_APK"
            echo "ps_apk=$PS_APK" >> $GITHUB_OUTPUT
            echo "PS_APK_PATH=$PS_APK" >> $GITHUB_ENV
          fi
          # Count total APKs
          APK_COUNT=$(find . -name "*release*.apk" -type f | wc -l)
          echo "Total APK files found: $APK_COUNT"
          echo "APK_COUNT=$APK_COUNT" >> $GITHUB_ENV

      - name: Sign the apk (pkcs12)
        working-directory: ./zipxtract_source
        run: |
          # 设置Android build-tools路径
          export ANDROID_HOME=/usr/local/lib/android/sdk
          export PATH="$ANDROID_HOME/build-tools/${{ env.ANDROID_BUILD_TOOLS }}:$PATH"
          # 验证apksigner可用
          which apksigner
          apksigner --version
          # 使用apksigner对APK签名
          apksigner sign \
            --ks "${{ env.KEYSTORE_PATH }}" \
            --ks-pass "pass:${{ secrets.KEYSTORE_PASSWORD }}" \
            --ks-key-alias "${{ secrets.KEY_ALIAS }}" \
            --ks-type PKCS12 \
            --out "./zipxtract-${{ env.BUILD_DATE }}.apk" \
            ${{ env.PS_APK_PATH }}
          # 验证签名
          apksigner verify --verbose "./zipxtract-${{ env.BUILD_DATE }}.apk"

      - name: Erase keystore, encrypt package and create release
        uses: ./ci_source/.github/actions/erase_aes256pac_release/
        with:
          # 文件路径为基于github.workspace的绝对路径
          P12_KEYSTORE_PATH: "./zipxtract_source/keystore.p12"
          ZIP_AES256_PWD: ${{ secrets.ZIP_AES256_PWD }}
          BUILD_ARTIFACT_PATH: "./zipxtract_source/zipxtract-${{ env.BUILD_DATE }}.apk"
          RELEASE_TAG_NAME: "${{ env.BUILD_DATE }}-zipxtract"