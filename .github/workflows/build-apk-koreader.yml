name: build-apk-koreader

on:
  workflow_dispatch:

env:
  JDK_VERSION: '17'
  ANDROID_COMPILE_SDK: '36'
  ANDROID_BUILD_TOOLS: '36.0.0'
  ANDROID_NDK_VERSION: '25.2.9519653'
  ANDROID_ARCH: arm64
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Clean runner environment
        run: |
          rm -rf ~/.gradle/caches/
          rm -rf ~/.gradle/daemon/
          rm -rf ~/.android/build-cache/
          rm -rf .gradle
          rm -rf ~/.ccache

      - name: Checkout koreader source
        uses: actions/checkout@main
        with:
          repository: koreader/koreader
          ref: master
          path: koreader_source
          fetch-depth: 0
          submodules: recursive

      - name: Checkout ci repository (self)
        uses: actions/checkout@main
        with:
          path: ci_source

      - name: Set build date
        run: echo "BUILD_DATE=$(TZ=UTC-8 date +'%y.%m.%d-%H.%M.%S')" >> $GITHUB_ENV

      - name: Setup java
        uses: actions/setup-java@main
        with:
          java-version: ${{ env.JDK_VERSION }}
          distribution: 'temurin'

      # 手动安装 Android SDK & NDK，确保指定版本
      - name: Setup android sdk & ndk
        run: |
          export ANDROID_HOME=$HOME/android-sdk
          mkdir -p $ANDROID_HOME/cmdline-tools
          cd $ANDROID_HOME/cmdline-tools
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          unzip -q commandlinetools-linux-11076708_latest.zip
          mv cmdline-tools latest
          export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$PATH
          yes | sdkmanager --licenses > /dev/null
          sdkmanager "platform-tools" \
                     "platforms;android-$ANDROID_COMPILE_SDK" \
                     "build-tools;$ANDROID_BUILD_TOOLS" \
                     "ndk;$ANDROID_NDK_VERSION"
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/$ANDROID_NDK_VERSION" >> $GITHUB_ENV
          echo "PATH=$ANDROID_HOME/ndk/$ANDROID_NDK_VERSION/toolchains/llvm/prebuilt/linux-x86_64/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/cmdline-tools/latest/bin:$PATH" >> $GITHUB_ENV

      - name: Verify ndk version
        run: |
          echo "NDK version:"
          $ANDROID_NDK_HOME/ndk-build --version || true
          which clang || true
          clang --version | head -1

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y make wget unzip ccache ninja-build python3-pip gettext
          pip3 install meson

      - name: Setup ccache
        uses: actions/cache@main
        with:
          path: ~/.ccache
          key: android-ccache-${{ github.sha }}
          restore-keys: |
            android-ccache-

      - name: Fetch third-party submodules
        working-directory: ./koreader_source
        run: make fetchthirdparty

      - name: Clean base build directory
        working-directory: ./koreader_source
        run: make clean || true

      - name: Check disk space
        run: df -h

      - name: Build koreader apk
        working-directory: ./koreader_source
        run: |
          export ANDROID_ARCH=${{ env.ANDROID_ARCH }}
          # 启用 Gradle 详细日志，便于排查打包错误
          export GRADLE_FLAGS="--info --stacktrace --no-daemon"
          make -j1 TARGET=android update

      - name: Locate and rename apk
        working-directory: ./koreader_source
        run: |
          mkdir -p "${{ github.workspace }}/dist"
          APK_FILES=$(find . -name "koreader-android-*.apk" -type f)
          if [ -z "$APK_FILES" ]; then
            echo "No APK found!"
            exit 1
          fi
          # 如果有多个，取第一个
          APK_FILE=$(echo "$APK_FILES" | head -1)
          echo "Found APK: $APK_FILE"
          mv "$APK_FILE" "${{ github.workspace }}/dist/koreader-unsigned.apk"

#       - name: Move and rename apk
#         working-directory: ./koreader_source
#         run: |
#           mkdir -p "${{ github.workspace }}/dist"
#           mv "koreader-android-arm64*.apk" "${{ github.workspace }}/dist/koreader-unsigned.apk"

      - name: Decode keystore.p12
        working-directory: ./koreader_source
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > keystore.p12

      - name: Sign apk (pkcs12)
        working-directory: ./koreader_source
        run: |
          export PATH="$ANDROID_HOME/build-tools/${{ env.ANDROID_BUILD_TOOLS }}:$PATH"
          apksigner sign \
            --ks keystore.p12 \
            --ks-pass "pass:${{ secrets.KEYSTORE_PASSWORD }}" \
            --ks-key-alias "${{ secrets.KEY_ALIAS }}" \
            --ks-type PKCS12 \
            --out "${{ github.workspace }}/dist/koreader-${{ env.BUILD_DATE }}.apk" \
            "${{ github.workspace }}/dist/koreader-unsigned.apk"
          apksigner verify --verbose "${{ github.workspace }}/dist/koreader-${{ env.BUILD_DATE }}.apk"

      - name: Erase keystore, encrypt package and create release
        uses: ./ci_source/.github/actions/erase_aes256pac_release/
        with:
          # 文件路径为基于github.workspace的绝对路径
          P12_KEYSTORE_PATH: "./koreader_source/keystore.p12"
          ZIP_AES256_PWD: ${{ secrets.ZIP_AES256_PWD }}
          BUILD_ARTIFACT_PATH: "./dist/koreader-${{ env.BUILD_DATE }}.apk"
          RELEASE_TAG_NAME: "${{ env.BUILD_DATE }}-koreader"
