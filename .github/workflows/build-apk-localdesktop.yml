name: build-apk-localdesktop
 
on:
  workflow_dispatch:
 
permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  ANDROID_KEYSTORE_PATH: 'target/x/release/android/gradle/app/release-key.p12'
  ANDROID_KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
  ANDROID_KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
  ANDROID_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
 
jobs:
  build:
    runs-on: ubuntu-latest
 
    steps:
      - name: Clean runner environment
        run: |
          rm -rf ~/.gradle/caches/transforms-*
          rm -rf ~/.android/build-cache/
          rm -rf ~/.gradle/wrapper/dists/*
 
      - name: Checkout source repo
        uses: actions/checkout@main
        with:
          repository: localdesktop/localdesktop
          ref: main
          path: localdesktop_source
          fetch-depth: 0
 
      - name: Checkout ci source repo (self)
        uses: actions/checkout@main
        with:
          path: ci_source
 
      - name: Initialize build environment
        id: init
        run: |
          echo "BUILD_DATE=$(TZ=UTC-8 date +"%y.%m.%d-%H.%M.%S")" >> $GITHUB_ENV
 
      - name: Setup Gradle 8.14.3
        uses: gradle/actions/setup-gradle@main
        with:
          gradle-version: "8.14.3"
 
      - name: Extract version
        id: extract_version
        run: echo "version=$(cargo metadata --format-version=1 --no-deps | jq -r '.packages[0].version')" >> "$GITHUB_OUTPUT"
 
      - name: Setup signing keystore
        working-directory: ${{ github.workspace }}/localdesktop_source
        run: |
          mkdir -p ./target/x/release/android/gradle/app
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > "./${{ env.ANDROID_KEYSTORE_PATH }}"
          # Verify keystore
          keytool -list -v -keystore "./${{ env.ANDROID_KEYSTORE_PATH }}" -storepass "$ANDROID_KEYSTORE_PASSWORD"
 
      - name: Update manifest.yaml to target api 35
        run: |
          sed -i 's/target_sdk_version: 33/target_sdk_version: 35/' "${{ github.workspace }}/localdesktop_source/manifest.yaml"
 
      - name: Install llvm
        run: sudo apt-get update && sudo apt-get install -y llvm
 
      - name: Download android ndk r28 # Xbuild does this automatically, but at the moment it does not yet support NDK r28, and we need it for 16 KB ELF alignment.
        run: |
          curl -o android-ndk-r28-linux.zip https://dl.google.com/android/repository/android-ndk-r28-linux.zip
          unzip android-ndk-r28-linux.zip
          rm android-ndk-r28-linux.zip
 
      - name: Prepare android.ndk # Replicate these steps from Xbuild's release workflow, so a fully compatible Android.ndk folder with NDK r28 is available offline in the working directory where Xbuild proceeds.
        run: |
          TOOLCHAIN=android-ndk-r28/toolchains/llvm/prebuilt/linux-x86_64
          CLANG_VERSION=$(ls $TOOLCHAIN/lib/clang | head -n 1)
          CLANG=$TOOLCHAIN/lib/clang/$CLANG_VERSION
 
          mkdir Android.ndk
          cp -r $TOOLCHAIN/sysroot/usr Android.ndk/
          cp -r $CLANG/lib/linux/aarch64/* Android.ndk/usr/lib/aarch64-linux-android/
          cp -r $CLANG/lib/linux/arm/* Android.ndk/usr/lib/arm-linux-androideabi/
          cp -r $CLANG/lib/linux/x86_64/* Android.ndk/usr/lib/x86_64-linux-android/
          cp -r $CLANG/lib/linux/i386/* Android.ndk/usr/lib/i686-linux-android/
 
          echo "INPUT(-lunwind)" > Android.ndk/usr/lib/aarch64-linux-android/libgcc.a
          echo "INPUT(-lunwind)" > Android.ndk/usr/lib/arm-linux-androideabi/libgcc.a
          echo "INPUT(-lunwind)" > Android.ndk/usr/lib/x86_64-linux-android/libgcc.a
          echo "INPUT(-lunwind)" > Android.ndk/usr/lib/i686-linux-android/libgcc.a
 
          mkdir -p ~/.cache/x/
          mv Android.ndk ~/.cache/x/
 
      - name: Build xbuild
        run: |
          WORKSPACE_DIR="${{ github.workspace }}/localdesktop_source/patches/xbuild"
          echo "Current directory: $(pwd)"
          echo "Workspace directory: $WORKSPACE_DIR"
          # 检查目录结构
          if [ -d "$WORKSPACE_DIR/xbuild" ] && [ -f "$WORKSPACE_DIR/xbuild/Cargo.toml" ]; then
            echo "Found xbuild package in subdirectory"
            cargo install --path "$WORKSPACE_DIR/xbuild"
          elif [ -d "$WORKSPACE_DIR/src" ] && [ -f "$WORKSPACE_DIR/Cargo.toml" ]; then
            echo "Found package in workspace root"
            cargo install --path "$WORKSPACE_DIR"
          else
            echo "Trying to build from workspace..."
            cd "$WORKSPACE_DIR"
            # 尝试不同的方法
            echo "Method 1: cargo install (without --path)"
            if cargo install 2>/dev/null; then
              echo "Success with method 1"
              exit 0
            fi
            echo "Method 2: cargo install from crates.io"
            cargo install xbuild
          fi
 
      - name: Ensure xbuild installed
        run: |
          # 确保安装了 xbuild
          if ! command -v x &> /dev/null; then
            echo "xbuild not found, installing from crates.io"
            cargo install xbuild
          else
            echo "xbuild already installed"
          fi
 
      - name: Check project structure
        run: |
          echo "=== Checking project structure ==="
          echo "localdesktop_source directory contents:"
          ls -la "${{ github.workspace }}/localdesktop_source/"
          echo "Checking for Cargo.toml..."
          if [ -f "${{ github.workspace }}/localdesktop_source/Cargo.toml" ]; then
            echo "Found Cargo.toml in localdesktop_source"
          else
            echo "Cargo.toml not found in localdesktop_source"
            echo "Searching recursively..."
            find "${{ github.workspace }}/localdesktop_source" -name "Cargo.toml" -type f | head -5
          fi
 
      - name: Build apk
        working-directory: ${{ github.workspace }}/localdesktop_source
        run: |
          echo "Current directory: $(pwd)"
          echo "Directory contents:"
          ls -la
          echo "Running x build..."
          x build --release --platform=android --arch=arm64 --format=apk
 
      # - name: Build apk
      #   run: x build --release --platform=android --arch=arm64 --format=apk
 
      - name: Find generated apk files
        working-directory: ${{ github.workspace }}/localdesktop_source
        run: |
          echo "=== Searching for APK files ==="
          find . -name "*.apk" -type f 2>/dev/null || echo "No APK files found"
          echo "=== Checking xbuild output structure ==="
          find ./target/x -type f -name "*.apk" 2>/dev/null | head -10 || echo "No APK files in ./target/x"
          echo "=== Checking gradle output ==="
          find ./target/x/release/android/gradle -name "*.apk" 2>/dev/null | head -10 || echo "No APK files in gradle output"
          echo "=== Checking alternative paths ==="
          # 检查可能的其他路径
          find . -path "*/build/outputs/apk/*" -name "*.apk" 2>/dev/null | head -10
          find . -path "*/build/outputs/bundle/*" -name "*.aab" 2>/dev/null | head -10
 
      - name: Sign the apk (pkcs12)
        working-directory: ${{ github.workspace }}/localdesktop_source
        run: |
          # 设置Android build-tools路径
          export ANDROID_HOME=/usr/local/lib/android/sdk
          export PATH="$ANDROID_HOME/build-tools/35.0.0:$PATH"
          # 验证apksigner可用
          which apksigner
          apksigner --version
          mkdir -p "../dist"
          # 使用apksigner对APK签名
          apksigner sign \
            --ks "./${{ env.ANDROID_KEYSTORE_PATH }}" \
            --ks-pass "pass:${{ env.ANDROID_KEYSTORE_PASSWORD }}" \
            --ks-key-alias "${{ env.ANDROID_KEY_ALIAS }}" \
            --ks-type PKCS12 \
            --out "../dist/localdesktop-${{ env.BUILD_DATE }}.apk" \
            "./target/x/release/android/gradle/app/build/outputs/apk/release/app-release-unsigned.apk"
          # 验证签名
          apksigner verify --verbose "../dist/localdesktop-${{ env.BUILD_DATE }}.apk"

      - name: Erase keystore, encrypt package and create release
        uses: ./ci_source/.github/actions/erase_aes256pac_release/
        with:
          P12_KEYSTORE_PATH: "./localdesktop_source/${{ env.ANDROID_KEYSTORE_PATH }}"
          ZIP_AES256_PWD: ${{ secrets.ZIP_AES256_PWD }}
          BUILD_ARTIFACT_PATH: "./dist/localdesktop-${{ env.BUILD_DATE }}.apk"
          RELEASE_TAG_NAME: "${{ env.BUILD_DATE }}-localdesktop"